<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Document Network — Document Detail View (Editable)</title>

<!-- D3.js -->
<script src="https://d3js.org/d3.v7.min.js"></script>

<!-- Google Font -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
  :root{
    --bg-grad-1:#f8fafc;
    --bg-grad-2:#eef2f7;
    --card-bg:#ffffff;
    --link:#64748b;
    --link-active:#0ea5e9;
    --node-grad-a:#0ea5e9;
    --node-grad-b:#6366f1;
    --text:#0f172a;
    --muted:#475569;
    --accent:#0ea5e9;
    --border: rgba(15,23,42,.10);
    --shadow-1: 0 10px 30px rgba(2,8,20,.06), 0 2px 8px rgba(2,8,20,.06);
    --shadow-2: 0 6px 16px rgba(14,165,233,.35);
    --chip-bg:#fff;
    --chip-border: rgba(15,23,42,.12);
    --pill-bg:#fff;
    --success:#10b981;
  }
  .theme-dark{
    --bg-grad-1:#0b1220;
    --bg-grad-2:#0b0f1a;
    --card-bg:#0e1626;
    --link:#7a8aa3;
    --link-active:#38bdf8;
    --node-grad-a:#22d3ee;
    --node-grad-b:#6366f1;
    --text:#e5e7eb;
    --muted:#9aa3b2;
    --accent:#38bdf8;
    --border: rgba(148,163,184,.18);
    --shadow-1: 0 10px 30px rgba(0,0,0,.35), 0 2px 8px rgba(0,0,0,.25);
    --shadow-2: 0 6px 16px rgba(56,189,248,.35);
    --chip-bg:#0b1322;
    --chip-border: rgba(148,163,184,.22);
    --pill-bg:#0b1322;
  }
  
  /* Normalize pill button layout + height across all buttons */
#viewToggleBtn,
#themeBtn,
#fileBtn,
.details-btn,
#detailBackToLib {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  min-height: 36px; /* matches the visual height of Current View/Theme */
}

/* Dark mode: match Add documents & Details to "Current View" style */
.theme-dark #fileBtn,
.theme-dark .details-btn{
  background: var(--card-bg);
  border: 1px solid var(--border);
  color: #ffffff;           /* already enforced, kept for clarity */
  box-shadow: var(--shadow-1);
}

/* Make them pill-y like the Current View button */
.theme-dark #fileBtn{
  border-radius: 999px;
  padding: 8px 12px;
  font-weight: 600;
}
.theme-dark .details-btn{
  border-radius: 999px;
  padding: 6px 12px;
  font-weight: 600;
}

/* Subtle hover to match the UI language */
.theme-dark #fileBtn:hover,
.theme-dark .details-btn:hover{
  border-color: var(--accent);
  box-shadow: var(--shadow-2);
}
/* Match hover effect for Current View toggle and Light/Dark toggle */
.theme-dark #viewToggleBtn:hover,
.theme-dark #themeBtn:hover{
  border-color: var(--accent);
  box-shadow: var(--shadow-2);
}
/* Unified hover effect with subtle accent tint */
#viewToggleBtn:hover,
#themeBtn:hover,
#fileBtn:hover,
.details-btn:hover,
#detailBackToLib:hover {
  border-color: var(--accent);
  box-shadow: var(--shadow-2);
  background: linear-gradient(
    135deg,
    color-mix(in srgb, var(--accent) 10%, var(--card-bg)),
    color-mix(in srgb, var(--accent) 20%, var(--card-bg))
  );
}
/* Softer hover glow for Light mode */
body:not(.theme-dark) #viewToggleBtn:hover,
body:not(.theme-dark) #themeBtn:hover,
body:not(.theme-dark) #fileBtn:hover,
body:not(.theme-dark) .details-btn:hover,
body:not(.theme-dark) #detailBackToLib:hover {
  border-color: var(--accent);
  background: linear-gradient(
    135deg,
    color-mix(in srgb, var(--accent) 4%, var(--card-bg)),
    color-mix(in srgb, var(--accent) 8%, var(--card-bg))
  );
  box-shadow: 0 3px 8px rgba(14,165,233,.20); /* lighter, softer glow */
}
  html, body { height:100%; }

  body {
    margin:0;
    font-family:'Inter', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    color:var(--text);
    background:linear-gradient(135deg, var(--bg-grad-1), var(--bg-grad-2));
  }

  .layout {
    display:grid;
    grid-template-columns: 360px 1fr;
    grid-template-rows: auto 1fr;
    grid-template-areas:
      "header header"
      "sidebar main";
    height:100vh;
    gap:14px;
    padding:16px;
    box-sizing:border-box;
    transition:grid-template-columns .22s ease;
  }

  body.doclib-full .layout{ grid-template-columns: 1fr 0; }
  body.doclib-full .main{ display:none; }
  body.doclib-full .sidebar{ box-shadow:var(--shadow-1); }

  .header {
    grid-area:header;
    display:flex; align-items:center; justify-content:space-between; gap:12px;
  }
  .brand { font-weight:700; font-size:18px; letter-spacing:.2px; }
  .controls { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }

  .search {
    display:flex; align-items:center; gap:8px;
    background:var(--card-bg); border:1px solid var(--border);
    border-radius:10px; padding:8px 10px;
    box-shadow:var(--shadow-1);
  }
  .search input{
    border:none; outline:none; font-size:13px; width:220px; background:transparent; color:var(--text);
  }
  .search svg path{ stroke:var(--muted); }

  .range {
    background:var(--card-bg); border:1px solid var(--border);
    border-radius:10px; padding:6px 10px;
    display:flex; align-items:center; gap:8px; font-size:12px;
    box-shadow:var(--shadow-1); color:var(--text);
    min-width: 260px;
  }
  .range input[type=range]{ width:160px; }
  .range.disabled { opacity:.45; pointer-events:none; }

  .btn {
    background:var(--accent); color:#001018; border:none; border-radius:10px;
    padding:8px 12px; font-weight:600; cursor:pointer;
    box-shadow:var(--shadow-2);
  }
  .btn.ghost{ background:transparent; color:var(--text); border:1px solid var(--border); box-shadow:none; }

  .icon-btn{
    display:flex; align-items:center; gap:8px;
    background:var(--card-bg); color:var(--text); border:1px solid var(--border);
    border-radius:10px; padding:8px 10px; cursor:pointer; box-shadow:var(--shadow-1);
  }
  /* Restore icon strokes for light/dark */
  .icon-btn svg path, .icon-btn svg circle{ stroke:var(--text); }

  #viewToggleBtn{
    display:flex; align-items:center; gap:8px;
    padding:8px 12px; border-radius:999px;
    border:1px solid var(--border);
    background:var(--card-bg);
    box-shadow:var(--shadow-1);
    font-weight:700; cursor:pointer;
    width: 240px;
    justify-content: center;
    white-space: nowrap;
  }
  #viewToggleBtn .target{ font-size:12px; }
  #viewToggleBtn .sep{ opacity:.35; }
  #viewToggleBtn .hint{ font-size:11px; color:var(--muted); }

  

/* Light mode: outlined pill style for ALL buttons */
body:not(.theme-dark) #viewToggleBtn,
body:not(.theme-dark) #fileBtn,
body:not(.theme-dark) #themeBtn,
body:not(.theme-dark) .details-btn,
body:not(.theme-dark) #detailBackToLib {
  background: var(--card-bg);
  color: var(--text);
  border: 1px solid var(--border);   /* outline baseline */
  box-shadow: var(--shadow-1);
  font-weight: 600;
  border-radius: 999px;
  padding: 8px 12px;
}



  body:not(.theme-dark) #viewToggleBtn .hint{ color: var(--muted); }
  body:not(.theme-dark) #viewToggleBtn svg path,
  body:not(.theme-dark) #viewToggleBtn svg circle{ stroke: var(--text); }

  .sidebar {
    grid-area:sidebar;
    background:var(--card-bg);
    border-radius:14px;
    box-shadow:var(--shadow-1);
    overflow:hidden;
    display:flex; flex-direction:column;
  }
  .side-head {
    padding:12px 14px; border-bottom:1px solid var(--border);
    display:flex; align-items:center; justify-content:space-between; gap:8px;
  }
  .side-title { font-weight:600; display:flex; align-items:center; gap:8px; }

  .drop {
    margin:12px; padding:16px; border:1.5px dashed var(--border);
    border-radius:12px; background:rgba(255,255,255,.04);
    text-align:center; font-size:13px; color:var(--muted);
  }
  .theme-dark .drop{ background:rgba(255,255,255,.02); }
  .drop.dragover { border-color:var(--accent); background:rgba(14,165,233,.08); color:var(--accent); }

  .docs { overflow:auto; padding:6px 6px 12px 6px; }
  .doc {
    border:1px solid var(--border); background:var(--card-bg); border-radius:12px;
    padding:10px; margin:8px; transition:box-shadow .15s ease, border-color .15s ease, background .15s ease;
  }
  .doc:hover{ border-color:rgba(14,165,233,.5); box-shadow:0 2px 10px rgba(14,165,233,.12); }
  .doc .row { display:flex; align-items:center; justify-content:space-between; gap:8px; }
  .doc .name { font-weight:600; font-size:13px; color:var(--text); }
  .doc .meta { color:var(--muted); font-size:12px; margin-top:4px; }

  .doc .head-actions{ display:flex; align-items:center; gap:8px; }
  .doc .details-btn{ padding: 8px 12px; border-radius: 999px; border:1px solid var(--border); background:var(--card-bg); cursor:pointer; }
  .doc .details-btn:hover{ border-color:var(--accent); }

  .doc-meta-inline{
    margin:8px 8px 4px 8px; background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    border:1px solid var(--border);
    border-radius:12px; padding:12px; color:var(--text);
  }
  .grid { display:grid; grid-template-columns: 1fr 1fr; gap:8px 12px; margin-top:8px; }
  .field { background:var(--card-bg); border:1px solid var(--border); border-radius:8px; padding:8px; }
  .field .label { font-size:11px; color:var(--muted); }
  .field .value { font-weight:600; margin-top:2px; color:var(--text); }

  .main {
    grid-area:main;
    position:relative;
    background:var(--card-bg);
    border-radius:14px;
    box-shadow:var(--shadow-1);
    overflow:hidden;
    min-height:320px;
  }

  .tooltip{
    position:absolute;
    pointer-events:none;
    padding:10px 12px;
    background:var(--card-bg);
    color:var(--text);
    border-radius:10px;
    font-size:13px;
    line-height:1.45;
    box-shadow:var(--shadow-1);
    opacity:0; transform:translateY(-2px);
    transition:opacity .16s ease, transform .16s ease;
    max-width:240px; border:1px solid var(--border); white-space:pre-wrap;
  }
  .tooltip.show{ opacity:1; transform:translateY(0); }

  .link{ stroke:var(--link); opacity:.45; transition:opacity .2s, stroke .2s, stroke-width .2s; }
  .link.active{ stroke:var(--link-active); opacity:.95; }

  .node circle{
    fill:url(#nodeGradient);
    stroke:#fff; stroke-width:2px;
    filter:drop-shadow(0 2px 5px rgba(2,8,20,.2));
    transition:r .2s ease, filter .2s ease;
  }
  .theme-dark .node circle{ stroke:rgba(255,255,255,.8); }
  .node text{ font-size:13px; font-weight:600; fill:#fff; text-anchor:middle; dominant-baseline:central; pointer-events:none; }
  .node-label-bg{ fill:rgba(15,23,42,.7); stroke:rgba(255,255,255,.35); stroke-width:.6px; pointer-events:none; }
  .legend{ position:absolute; left:12px; bottom:10px; background:rgba(255,255,255,.85); border:1px solid var(--border); backdrop-filter:saturate(140%) blur(6px); padding:6px 10px; border-radius:8px; font-size:12px; color:#0f172a; }
  .theme-dark .legend{ background:rgba(15,23,42,.65); color:#e5e7eb; }
  .hint{ position:absolute; right:12px; bottom:10px; font-size:12px; color:var(--muted); background:rgba(255,255,255,.85); border:1px solid var(--border); padding:6px 10px; border-radius:8px; }
  .theme-dark .hint{ background:rgba(15,23,42,.65); color:#e5e7eb; }

  /* Full-page Document Detail panel (editable) */
  .detail-panel{ position:fixed; inset:0; z-index:50; display:none; background:linear-gradient(135deg, var(--bg-grad-1), var(--bg-grad-2)); }
  .detail-panel.show{ display:block; }
  .detail-inner{ height:100%; display:grid; grid-template-rows:auto 1fr; }
  .detail-bar{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding:14px 16px; background:var(--card-bg); border-bottom:1px solid var(--border); box-shadow:var(--shadow-1); }
  .detail-title{ display:flex; align-items:center; gap:10px; font-weight:700; }
  .detail-actions{ display:flex; gap:8px; }
  .detail-content{ height:100%; padding:16px; overflow:auto; display:grid; grid-template-columns: 360px 1fr; gap:16px; }
  .detail-card{ background:var(--card-bg); border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow-1); padding:12px; }
  .detail-card h4{ margin:0 0 8px 0; font-size:14px; }
  .kv{ display:grid; grid-template-columns: 1fr; gap:8px; }
  .kv .row{ display:grid; grid-template-columns: 140px 1fr; gap:10px; align-items:center; }
  .kv .key{ font-size:12px; color:var(--muted); }
  .kv .val{ font-weight:600; }

  .section{ margin-bottom:16px; }
  .section h5{ margin:0 0 8px 0; font-size:13px; display:flex; align-items:center; justify-content:space-between; gap:8px; }
  .section .stamp{ font-size:11px; color:var(--muted); }
  .section .box{ min-height:120px; border:1px solid var(--border); border-radius:10px; padding:12px; background:var(--card-bg); line-height:1.55; outline:none; }
  .section .box[contenteditable="true"]:focus{ box-shadow:0 0 0 2px var(--accent) inset; }
  .save-badge{ font-size:11px; border:1px solid var(--border); border-radius:999px; padding:2px 8px; }
  .save-badge.ok{ color:#065f46; border-color:#10b981; }
  .pill{ padding:6px 10px; border:1px solid var(--border); border-radius:999px; background:var(--pill-bg); font-size:12px; }

  /* New styles for chevron + counters + dark-mode button text */
  .doc .head-left{ display:flex; align-items:flex-start; gap:10px; }
  .doc .chev{ transition: transform .18s ease; margin-top:2px; }
  .doc.expanded .chev{ transform: rotate(90deg); }
  .doc .chev svg path{ stroke: var(--text); }
  
  .count.dim{ font-size:11px; color: var(--muted); margin-left:6px; }
  .count.warn{ font-size:11px; color: #b45309; background: rgba(245,158,11,.12); border:1px solid rgba(245,158,11,.35); padding:2px 6px; border-radius:999px; margin-left:6px; display:inline-flex; align-items:center; gap:6px; }
  .count.warn svg path, .count.warn svg circle{ stroke: #b45309; }
  .count.alert{ font-size:11px; color: #b91c1c; background: rgba(239,68,68,.12); border:1px solid rgba(239,68,68,.35); padding:2px 6px; border-radius:999px; margin-left:6px; display:inline-flex; align-items:center; gap:6px; }
  .count.alert svg path{ stroke: #b91c1c; }
  
  
/* Unified button typography */
#viewToggleBtn,
#themeBtn,
#fileBtn,
.details-btn,
#detailBackToLib {
  font-size: 12px;
  line-height: 1;
}

/* Dark mode: make all button text white for better legibility */
  .theme-dark .btn,
  .theme-dark .icon-btn,
  .theme-dark .details-btn{ color:#ffffff !important; }
  .theme-dark #viewToggleBtn .hint{ color:#ffffff !important; opacity:.85; }
  
  /* Details button baseline resets so it stands out on dark */
  .details-btn{ background:var(--card-bg); color:var(--text); border:1px solid var(--border); }
  .details-btn:hover{ border-color:var(--accent); }

  /* Detail view tabs */
  .detail-tabs { display:flex; gap:8px; align-items:center; }
  .tab-btn{
    appearance:none; border:1px solid var(--border); background:var(--card-bg);
    padding:8px 12px; border-radius:999px; font-weight:600; font-size:12px; cursor:pointer;
    box-shadow:var(--shadow-1); color:var(--text);
  }
  .tab-btn:hover{ border-color: var(--accent); box-shadow: var(--shadow-2); }
  .tab-btn[aria-pressed="true"]{
    border-color: var(--accent);
    background: linear-gradient(
      135deg,
      color-mix(in srgb, var(--accent) 10%, var(--card-bg)),
      color-mix(in srgb, var(--accent) 20%, var(--card-bg))
    );
  }
  .theme-dark .tab-btn{ color:#fff; }

</style>

</head>

<body>
  <div class="layout">
    <div class="header">
      <div class="brand">Document Network</div>
      <div class="controls">
        <div class="search">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15z" stroke="#64748b" stroke-width="2" stroke-linecap="round"/></svg>
          <input id="searchInput" placeholder="Search documents..." />
        </div>

        <div class="range" id="rangeWrap">
          <span>Link threshold</span>
          <input type="range" id="threshold" min="0" max="100" value="30" />
          <span id="thLabel">0.30</span>
        </div>

        <button id="viewToggleBtn" class="icon-btn" aria-pressed="false" title="Switch to Document Library" aria-keyshortcuts="v">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path id="viewIcon" d="M3 12h18M3 6h12M3 18h12" stroke-width="2" stroke-linecap="round"/>
          </svg>
          <span class="target" id="viewToggleTarget">Current View: Diagram</span>
          <span class="sep">•</span>
          <span class="hint">press V</span>
        </button>

        <button class="btn" id="fileBtn">Add documents</button>
        <input type="file" id="fileInput" multiple style="display:none" accept=".txt,.md,.pdf,.docx,.html,.csv"/>

        <button class="icon-btn" id="themeBtn" aria-pressed="false" title="Toggle light/dark mode">
          <svg id="themeIcon" width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <circle cx="12" cy="12" r="4" stroke-width="2" />
            <path d="M12 2v2M12 20v2M4 12H2M22 12h-2M5 5l1.5 1.5M17.5 17.5L19 19M5 19l1.5-1.5M17.5 6.5L19 5" stroke-width="2" stroke-linecap="round"/>
          </svg>
          <span id="themeLabel" style="font-weight:600;font-size:12px;">Light</span>
        </button>
      </div>
    </div>

    <aside class="sidebar">
      <div class="side-head">
        <div class="side-title"><span>Documents</span></div>
        <div class="subtle" id="docCount">0 items</div>
      </div>
      <div class="drop" id="dropZone">
        Drop files here (.txt/.md recommended for demo).<br/>Or click “Add documents”.
      </div>
      <div class="docs" id="docList" aria-live="polite"></div>
    </aside>

    <main class="main" id="graph"></main>
  </div>

<!-- Full-page Document Detail panel -->
<div class="detail-panel" id="detailPanel" role="dialog" aria-modal="true" aria-labelledby="detailDocName">
  <div class="detail-inner">
    <div class="detail-bar">
      <div class="detail-title">
        <span class="pill" id="detailTopic">Topic</span>
        <span id="detailDocName">Document name</span>
      </div>
      <div class="detail-actions">
        <div class="detail-tabs">
          <button class="tab-btn" id="tabRead" type="button" aria-pressed="true" title="View published content">Read</button>
          <button class="tab-btn" id="tabEdit" type="button" aria-pressed="false" title="Edit draft (autosaves locally)">Propose Edits</button>
        </div>
                <button class="btn ghost" id="detailBackToLib">Back to Library</button>
        
      </div>
    </div>
    <div class="detail-content">
      <div class="detail-card">
        <h4>Metadata</h4>
        <div class="kv" id="detailMeta"></div>
        <div style="height:10px"></div>
        <h4>Supporting Documents</h4>
        <div id="detailSupports" class="chips"></div>
        <div style="height:10px"></div>
        <h4>Document History</h4>
        <ul id="detailHistory" style="margin:8px 0 0 16px; padding:0;"></ul>
      </div>
      <div>
        <div class="detail-card section">
          <h4>Context</h4>
          <div class="section-head">
            <div class="stamp" id="stamp-context"></div>
          </div>
          <div class="box" id="detailContext" contenteditable="true" spellcheck="true"></div>
        </div>
        <div class="detail-card section">
          <h4>Scope</h4>
          <div class="section-head">
            <div class="stamp" id="stamp-scope"></div>
          </div>
          <div class="box" id="detailScope" contenteditable="true" spellcheck="true"></div>
        </div>
        <div class="detail-card section">
          <h4>Content</h4>
          <div class="section-head">
            <div class="stamp" id="stamp-content"></div>
          </div>
          <div class="box" id="detailContent" contenteditable="true" spellcheck="true"></div>
        </div>
        <div class="detail-card section">
          <h4>Roles &amp; Responsibilities</h4>
          <div class="section-head">
            <div class="stamp" id="stamp-roles"></div>
          </div>
          <div class="box" id="detailRoles" contenteditable="true" spellcheck="true"></div>
        </div>
        <div class="detail-card section">
          <h4>Appendices</h4>
          <div class="section-head">
            <div class="stamp" id="stamp-appendices"></div>
          </div>
          <div class="box" id="detailAppendices" contenteditable="true" spellcheck="true"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// ------------------------------ Theme: init & toggle ------------------------------
(function initTheme(){
  const saved = localStorage.getItem('docnet-theme');
  const preferDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
  const startDark = saved ? (saved === 'dark') : preferDark;
  if(startDark) document.body.classList.add('theme-dark');
  updateThemeButton();
})();

document.getElementById('themeBtn').addEventListener('click', () => {
  document.body.classList.toggle('theme-dark');
  const dark = document.body.classList.contains('theme-dark');
  localStorage.setItem('docnet-theme', dark ? 'dark' : 'light');
  updateThemeButton();
});

function updateThemeButton(){
  const dark = document.body.classList.contains('theme-dark');
  const label = document.getElementById('themeLabel');
  const icon = document.getElementById('themeIcon');
  label.textContent = dark ? 'Dark' : 'Light';
  document.getElementById('themeBtn').setAttribute('aria-pressed', dark ? 'true' : 'false');
  // Use CSS stroke for visibility. Swap glyphs for sun/moon.
  if(dark){
    icon.innerHTML = '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>';
  } else {
    icon.innerHTML = '<circle cx="12" cy="12" r="4" stroke-width="2" /><path d="M12 2v2M12 20v2M4 12H2M22 12h-2M5 5l1.5 1.5M17.5 17.5L19 19M5 19l1.5-1.5M17.5 6.5L19 5" stroke-width="2" stroke-linecap="round"/>';
  }
}

// ------------------------------ Helpers ------------------------------
const stopwords = new Set("a,an,and,are,as,at,be,by,for,from,has,he,in,is,it,its,of,on,that,the,to,was,were,will,with,or,not,if,then,into,over,under,between,than,about,after,before,again,once,only,other,own,same,so,too,very,can,just,should,now".split(","));

function tokenize(text){
  return (text||"")
    .toLowerCase()
    .replace(/[\\u2018\\u2019\\u201C\\u201D]/g, "'")
    .replace(/[^a-z0-9\\s]/g, " ")
    .split(/\\s+/)
    .filter(t => t && !stopwords.has(t) && t.length > 1);
}
function tf(tokens){
  const map = new Map();
  tokens.forEach(t => map.set(t, (map.get(t)||0)+1));
  const N = tokens.length || 1;
  for(const [k,v] of map) map.set(k, v/N);
  return map;
}
function idf(allDocs){
  const df = new Map(); const N = allDocs.length || 1;
  for(const doc of allDocs){
    const unique = new Set(doc.tokens);
    unique.forEach(t => df.set(t, (df.get(t)||0)+1));
  }
  const idfMap = new Map();
  for(const [t, dfi] of df) idfMap.set(t, Math.log((N+1)/(dfi+1)) + 1);
  return idfMap;
}
function tfidfVec(tfMap, idfMap){
  const vec = new Map();
  for(const [t, w] of tfMap){
    if(idfMap.has(t)) vec.set(t, w * idfMap.get(t));
  }
  return vec;
}
function cosineSim(vecA, vecB){
  let dot=0, normA=0, normB=0;
  for(const [t, w] of vecA){
    if(vecB.has(t)) dot += w * vecB.get(t);
    normA += w*w;
  }
  for(const [, w] of vecB){ normB += w*w; }
  const denom = Math.sqrt(normA) * Math.sqrt(normB);
  return denom ? dot/denom : 0;
}
function splitSentences(text){
  const out = [];
  let start = 0;
  const re = /([^.!?]+[.!?])|([^\\n]+(\\n|$))/g;
  let m;
  while ((m = re.exec(text)) !== null){
    const s = m[0].trim();
    if(s.length < 3) continue;
    const idx = text.indexOf(s, start);
    const end = idx + s.length;
    out.push({ text: s, start: idx, end: end });
    start = end;
  }
  if(out.length === 0 && text) out.push({ text, start:0, end:text.length });
  return out;
}
function escapeHtml(s){ return s.replace(/[&<>\"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\\\"":"&quot;","'":"&#39;" }[m])); }

// Governance placeholders
const OWNER_NAMES = ["Alex Morgan","Priya Nair","Liam O'Connor","Sofia Rossi","Chen Wei","Amira Haddad","Jonas Müller","Isabella García"];
const APPROVER_NAMES = ["Maya Patel","Tom Andersen","Noah Brown","Olivia Martin","Hiro Tanaka","Grace Lee","Samuel Kim","Ava Thompson"];
const TOPICS = ["Information Security","Operational Risk","Vendor Oversight","Business Continuity","Privacy","Access Management","Incident Response","Audit"];
function pick(arr, seed){ return arr[seed % arr.length]; }
function formatDate(d){
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');
  return y+'-'+m+'-'+day;
}
function fakeGovernance(seed){
  const now = new Date();
  const monthsBack = (seed % 18) + 1;
  const eff = new Date(now); eff.setMonth(eff.getMonth() - monthsBack);
  const next = new Date(eff); next.setMonth(next.getMonth() + 12);
  return {
    owner: pick(OWNER_NAMES, seed),
    approver: pick(APPROVER_NAMES, seed+3),
    effectiveDate: formatDate(eff),
    nextApprovalDate: formatDate(next),
    topic: pick(TOPICS, seed+5)
  };
}

// ------------------------------ App state ------------------------------
let documents = [];
let links = [];
let idCounter = 1;
let expandedDocId = null;

// Detail state
let currentDetailId = null;

// ------------------------------ UI elements ------------------------------
const fileBtn = document.getElementById('fileBtn');
const fileInput = document.getElementById('fileInput');
const dropZone = document.getElementById('dropZone');
const docList = document.getElementById('docList');
const docCount = document.getElementById('docCount');
const searchInput = document.getElementById('searchInput');
const thresholdEl = document.getElementById('threshold');
const thLabel = document.getElementById('thLabel');
const rangeWrap = document.getElementById('rangeWrap');
const viewToggleBtn = document.getElementById('viewToggleBtn');
const viewToggleTarget = document.getElementById('viewToggleTarget');
const viewIcon = document.getElementById('viewIcon');

// Detail panel elements
const detailPanel = document.getElementById('detailPanel');
const detailDocName = document.getElementById('detailDocName');
const detailTopic = document.getElementById('detailTopic');
const detailMeta = document.getElementById('detailMeta');
const detailSupports = document.getElementById('detailSupports');
const detailHistory = document.getElementById('detailHistory');
const detailContext = document.getElementById('detailContext');
const detailScope = document.getElementById('detailScope');
const detailContent = document.getElementById('detailContent');
const detailRoles = document.getElementById('detailRoles');
const detailAppendices = document.getElementById('detailAppendices');
const detailBackToLib = document.getElementById('detailBackToLib');

// ------------------------------ View toggle ------------------------------
function applyView(mode){
  const isLibrary = (mode === 'library');
  document.body.classList.toggle('doclib-full', isLibrary);
  viewToggleBtn.setAttribute('aria-pressed', isLibrary ? 'true' : 'false');
  rangeWrap.classList.toggle('disabled', isLibrary);
  viewToggleTarget.textContent = isLibrary ? 'Current View: Library' : 'Current View: Diagram';
  // Switch icon to hint target
  if(isLibrary){
    viewIcon.setAttribute('d','M4 4h16v6H4zM4 14h16v6H4z');
  } else {
    viewIcon.setAttribute('d','M3 12h18M3 6h12M3 18h12');
  }
  localStorage.setItem('docnet-view', mode);
}
function toggleView(){
  const isLibrary = document.body.classList.contains('doclib-full');
  applyView(isLibrary ? 'diagram' : 'library');
}
viewToggleBtn.addEventListener('click', toggleView);
document.addEventListener('keydown', (e) => {
  if(e.key.toLowerCase()==='v' && !e.metaKey && !e.ctrlKey && !e.altKey){
    e.preventDefault(); toggleView();
  }
});
(function initView(){
  const saved = localStorage.getItem('docnet-view');
  applyView(saved === 'library' ? 'library' : 'diagram');
})();

// ------------------------------ File handling ------------------------------
async function handleFiles(fileList){
  const files = Array.from(fileList||[]);
  for (const file of files){
    const ext = (file.name.split('.').pop()||'').toLowerCase();
    let text = '';
    if (ext === 'txt' || ext === 'md' || ext === 'csv' || ext === 'html'){
      text = await file.text();
    } else if (ext === 'pdf' || ext === 'docx'){
      text = ''; // placeholder for demo
    } else {
      continue;
    }
    addDocument(file.name, text);
  }
  recomputeLinks();
  drawGraph();
  renderDocList();
}
fileBtn.addEventListener('click', ()=>fileInput.click());
fileInput.addEventListener('change', (e)=> handleFiles(e.target.files));
['dragenter','dragover'].forEach(ev => dropZone.addEventListener(ev, (e)=>{ e.preventDefault(); e.stopPropagation(); dropZone.classList.add('dragover'); }));
['dragleave','drop'].forEach(ev => dropZone.addEventListener(ev, (e)=>{ e.preventDefault(); e.stopPropagation(); dropZone.classList.remove('dragover'); }));
dropZone.addEventListener('drop', (e)=> handleFiles(e.dataTransfer.files));

function addDocument(name, text){
  const tokens = tokenize(text);
  const tfMap = tf(tokens);
  const summary = (text||'').split(/\\s+/).slice(0,40).join(' ');
  const sentences = splitSentences(text).map(s => {
    const toks = tokenize(s.text);
    return { ...s, tokens: toks, tf: tf(toks), vec: null };
  });
  const meta = fakeGovernance(idCounter);
  const doc = { 
    id: 'doc' + (idCounter++), name, text, tokens, tf: tfMap, vec:null, summary, sentences,
    owner: meta.owner, approver: meta.approver, effectiveDate: meta.effectiveDate, nextApprovalDate: meta.nextApprovalDate,
    topic: meta.topic, supportIds: [], history: [],
    details: {
      context: "Add the background, purpose, and business context for this document.",
      scope: "Describe what is in and out of scope.",
      content: "Place or summarize the main content here.",
      roles: "List key roles and responsibilities involved.",
      appendices: "Include supporting materials, references, glossary, etc."
    }
  };
  const idx = documents.length;
  if(idx >= 1) doc.supportIds.push(documents[idx-1].id);
  if(idx >= 2) doc.supportIds.push(documents[idx-2].id);
  doc.history = [
    { version: "v" + (1 + Math.floor(Math.random()*2)) + ".0", date: meta.effectiveDate, note: "Initial publication" },
    { version: "v" + (2 + Math.floor(Math.random()*2)) + ".1", date: meta.nextApprovalDate, note: "Scheduled review" }
  ];
  documents.push(doc);
  docCount.textContent = documents.length + ' items';
}

// ------------------------------ Similarity & links ------------------------------
function recomputeLinks(){
  const idfMap = idf(documents.map(d => ({tokens: d.tokens})));
  documents.forEach(d => d.vec = tfidfVec(d.tf, idfMap));

  const threshold = thresholdEl.value/100;
  const out = [];
  for(let i=0;i<documents.length;i++){
    for(let j=i+1;j<documents.length;j++){
      const a = documents[i], b = documents[j];
      const sim = cosineSim(a.vec, b.vec);
      if (sim >= threshold) out.push({ source: a.id, target: b.id, value: sim });
    }
  }
  links = out;
}
thresholdEl.addEventListener('input', () => { 
  thLabel.textContent = (thresholdEl.value/100).toFixed(2); 
  recomputeLinks(); drawGraph(); 
});
searchInput.addEventListener('input', renderDocList);

// ------------------------------ Sidebar rendering (with Details button) ------------------------------

function renderDocList(){
  const q = (searchInput.value||'').toLowerCase();
  const list = document.getElementById('docList');
  list.innerHTML = '';
  documents
    .filter(d => d.name.toLowerCase().includes(q) || (d.text||'').toLowerCase().includes(q))
    .forEach(d => {
      const card = document.createElement('div');
      const isExpanded = (expandedDocId === d.id);
      card.className = 'doc' + (isExpanded ? ' expanded' : '');
      card.setAttribute('data-docid', d.id);

      // Header with chevron + details button
      card.innerHTML = '<div class="row">\
                          <div class="head-left">\
                            <div class="chev" aria-hidden="true">\
                              <svg width="16" height="16" viewBox="0 0 24 24" fill="none">\
                                <path d="M9 6l6 6-6 6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\
                              </svg>\
                            </div>\
                            <div>\
                              <div class="name">'+d.name+'</div>\
                              <div class="meta">'+d.tokens.length+' tokens • Owner: '+d.owner+' • Topic: '+d.topic+'</div>\
                            </div>\
                          </div>\
                          <div class="head-actions">\
                            <button class="details-btn" title="Open Details" data-docid="'+d.id+'">Details</button>\
                          </div>\
                        </div>';

      // Details button (doesn't toggle expansion)
      card.querySelectorAll('button.details-btn[title="Open Details"]').forEach(btn => {
        btn.addEventListener('click', (ev) => {
          ev.stopPropagation();
          const id = btn.getAttribute('data-docid');
          openDetail(id);
        });
      });

      // Card click toggles expansion
      card.addEventListener('click', () => {
        expandedDocId = (expandedDocId === d.id) ? null : d.id;
        renderDocList();
      });

      if (isExpanded) card.classList.add('expanded');
      list.appendChild(card);

      // Expanded inline metadata
      if (isExpanded){
        const meta = document.createElement('div');
        meta.className = 'doc-meta-inline';

        const supports = (d.supportIds||[]).map(id => {
          const sd = documents.find(x => x.id===id);
          return sd ? '<span class="chip" data-docid="'+sd.id+'" title="Open '+sd.name+'">'+sd.name+'</span>' : '';
        }).join('');

        // Counters
        function daysBetween(a, b){
          const ms = Date.parse(b) - Date.parse(a);
          return Math.round(ms / (1000*60*60*24));
        }
        const nowISO = new Date().toISOString().slice(0,10);
        const daysSinceEff = daysBetween(d.effectiveDate, nowISO);
        const daysUntilNext = daysBetween(nowISO, d.nextApprovalDate);

        let nextBadge = '<span class="count dim">('+daysUntilNext+' days to go)</span>';
        if (daysUntilNext < 0){
          nextBadge = '<span class="count alert"><svg width="14" height="14" viewBox="0 0 24 24" fill="none"><path d="M12 9v4m0 4h.01M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg> Overdue</span>';
        } else if (daysUntilNext <= 90){
          nextBadge = '<span class="count warn"><svg width="14" height="14" viewBox="0 0 24 24" fill="none"><path d="M12 8v4m0 4h.01" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><circle cx="12" cy="12" r="9" stroke-width="2"/></svg> '+daysUntilNext+' days to go</span>';
        }

        const history = (d.history||[]).map(h => '<li><strong>'+h.version+'</strong> — '+h.date+' — <span class="subtle">'+h.note+'</span></li>').join('');

        meta.innerHTML = '\
          <details open>\
            <summary><strong>Governance</strong></summary>\
            <div class="grid" style="margin-top:8px;">\
              <div class="field"><div class="label">Topic</div><div class="value">'+d.topic+'</div></div>\
              <div class="field"><div class="label">Owner</div><div class="value">'+d.owner+'</div></div>\
              <div class="field"><div class="label">Effective Date</div><div class="value">'+d.effectiveDate+' <span class="count dim">('+daysSinceEff+' days ago)</span></div></div>\
              <div class="field"><div class="label">Next Approval Date</div><div class="value">'+d.nextApprovalDate+' '+nextBadge+'</div></div>\
            </div>\
          </details>\
          <details style="margin-top:10px;" open>\
            <summary><strong>Supporting Documents</strong></summary>\
            <div class="chips" style="margin-top:8px;">'+(supports || '<span class="subtle">None</span>')+'</div>\
          </details>\
          <details style="margin-top:10px;">\
            <summary><strong>Document History</strong></summary>\
            <ul style="margin:8px 0 0 16px; padding:0;">'+(history || '<li class="subtle">No history</li>')+'</ul>\
          </details>\
          <details style="margin-top:10px;">\
            <summary><strong>Summary</strong></summary>\
            <div class="subtle" style="margin-top:8px;">'+(d.summary || '<em>No preview for this file type in demo.</em>')+'</div>\
          </details>';

        meta.querySelectorAll('.chip').forEach(ch => {
          ch.addEventListener('click', (ev) => {
            ev.stopPropagation();
            const id = ch.getAttribute('data-docid');
            expandedDocId = id;
            renderDocList();
          });
        });
        list.appendChild(meta);
      }
    });
}
// ------------------------------ Document Detail (editable + autosave) ------------------------------
function getUserName(){
  let name = localStorage.getItem('docnet-username') || '';
  if(!name){
    name = prompt('Your name for edit stamps? (stored only in this browser)', 'Editor');
    if(name) localStorage.setItem('docnet-username', name);
    else name = 'Editor';
  }
  return name;
}
function keyFor(docId, section){ return `docnet:detail:${docId}:${section}`; }
function saveSection(docId, section, text){
  const user = getUserName();
  const updatedAt = new Date().toISOString();
  const payload = { text, user, updatedAt };
  localStorage.setItem(keyFor(docId, section), JSON.stringify(payload));
  updateStamp(section, payload);
}
function loadSection(docId, section, fallback){
  try{
    const raw = localStorage.getItem(keyFor(docId, section));
    if(!raw) return { text: fallback||'', user:null, updatedAt:null };
    return JSON.parse(raw);
  }catch(e){
    return { text: fallback||'', user:null, updatedAt:null };
  }
}
function formatStamp(u, tISO){
  if(!tISO) return '';
  const d = new Date(tISO);
  const date = d.toLocaleString();
  return `Last updated by ${u||'—'} on ${date}`;
}
function updateStamp(section, payload){
  const el = document.getElementById(`stamp-${section}`);
  if(el) el.textContent = formatStamp(payload.user, payload.updatedAt);
}

function wireEditableBox(el, docId, section, fallbackText){
  const { text, user, updatedAt } = loadSection(docId, section, fallbackText);
  el.innerText = text || fallbackText || '';
  updateStamp(section, {user, updatedAt});

  let saveTimer = null;
  el.addEventListener('input', ()=>{
    if(saveTimer) clearTimeout(saveTimer);
    saveTimer = setTimeout(()=>{
      saveSection(docId, section, el.innerText.trim());
      // transient saved badge
      showSavedBadge(el);
    }, 420);
  });
}
function showSavedBadge(el){
  let badge = document.createElement('span');
  badge.className = 'save-badge ok';
  badge.textContent = 'Saved';
  badge.style.marginLeft = '8px';
  badge.style.opacity = '0';
  // append next to heading stamp if possible
  const parentCard = el.closest('.detail-card');
  if(parentCard){
    const heading = parentCard.querySelector('h4');
    if(heading){
      heading.appendChild(badge);
      requestAnimationFrame(()=>{
        badge.style.transition = 'opacity .15s ease';
        badge.style.opacity = '1';
        setTimeout(()=>{
          badge.style.opacity = '0';
          setTimeout(()=> badge.remove(), 250);
        }

// ------------------------------ Detail read/edit tabs ------------------------------
let detailMode = 'read';
function setDetailMode(mode){
  detailMode = mode;
  const editable = (mode === 'edit');
  const boxes = [detailContext, detailScope, detailContent, detailRoles, detailAppendices];
  boxes.forEach(b => { if (b) b.setAttribute('contenteditable', editable ? 'true' : 'false'); });
  const readBtn = document.getElementById('tabRead');
  const editBtn = document.getElementById('tabEdit');
  if (readBtn && editBtn){
    readBtn.setAttribute('aria-pressed', mode === 'read' ? 'true' : 'false');
    editBtn.setAttribute('aria-pressed', mode === 'edit' ? 'true' : 'false');
  }
}
// Attach listeners once elements are available
document.addEventListener('DOMContentLoaded', () => {
  const readBtn = document.getElementById('tabRead');
  const editBtn = document.getElementById('tabEdit');
  if (readBtn) readBtn.addEventListener('click', () => setDetailMode('read'));
  if (editBtn) editBtn.addEventListener('click', () => setDetailMode('edit'));
});

, 900);
      });
      return;
    }
  }
  // fallback: append after box
  el.insertAdjacentElement('afterend', badge);
  requestAnimationFrame(()=>{
    badge.style.transition = 'opacity .15s ease';
    badge.style.opacity = '1';
    setTimeout(()=>{
      badge.style.opacity = '0';
      setTimeout(()=> badge.remove(), 250);
    }, 900);
  });
}

function openDetail(docId){
  const doc = documents.find(x => x.id === docId);
  if(!doc) return;
  currentDetailId = docId;
  // Header
  detailDocName.textContent = doc.name;
  detailTopic.textContent = doc.topic;
  // Meta
  detailMeta.innerHTML = '';
  [['Owner',doc.owner],['Approver',doc.approver],['Effective Date',doc.effectiveDate],['Next Approval Date',doc.nextApprovalDate]].forEach(([k,v])=>{
    const row = document.createElement('div');
    row.className = 'row';
    row.innerHTML = '<div class="key">'+k+'</div><div class="val">'+(v||'—')+'</div>';
    detailMeta.appendChild(row);
  });
  // Supports
  detailSupports.innerHTML='';
  if((doc.supportIds||[]).length===0){
    detailSupports.innerHTML = '<span class="subtle">None</span>';
  } else {
    doc.supportIds.forEach(id=>{
      const sd = documents.find(x=>x.id===id);
      if(!sd) return;
      const pill = document.createElement('span');
      pill.className = 'pill';
      pill.textContent = sd.name;
      pill.title = 'Open '+sd.name+' in Details';
      pill.addEventListener('click', ()=> openDetail(sd.id));
      detailSupports.appendChild(pill);
    });
  }
  // History
  detailHistory.innerHTML='';
  (doc.history||[]).forEach(h=>{
    const li = document.createElement('li');
    li.innerHTML = '<strong>'+h.version+'</strong> — '+h.date+' — <span class="subtle">'+h.note+'</span>';
    detailHistory.appendChild(li);
  });

  // Editable sections with autosave + stamps
  wireEditableBox(detailContext, doc.id, 'context', doc.details.context||'');
  wireEditableBox(detailScope, doc.id, 'scope', doc.details.scope||'');
  wireEditableBox(detailContent, doc.id, 'content', doc.details.content || (doc.summary||''));
  wireEditableBox(detailRoles, doc.id, 'roles', doc.details.roles||'');
  wireEditableBox(detailAppendices, doc.id, 'appendices', doc.details.appendices||'');

  setDetailMode('read');
  detailPanel.classList.add('show');
  detailBackToLib.focus();
  applyView('library');
}

// Close handlers
detailBackToLib.addEventListener('click', () => { detailPanel.classList.remove('show'); applyView('library'); });
document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape' && detailPanel.classList.contains('show')) detailPanel.classList.remove('show'); });

// ------------------------------ Graph (D3) ------------------------------
const container = d3.select("#graph");
const width  = container.node().clientWidth;
const height = container.node().clientHeight;

const svg = container.append("svg");
const g = svg.append("g");

const defs = svg.append("defs");
const grad = defs.append("linearGradient")
  .attr("id","nodeGradient").attr("x1","0%").attr("y1","0%").attr("x2","100%").attr("y2","100%");
grad.append("stop").attr("offset","0%").attr("stop-color","var(--node-grad-a)");
grad.append("stop").attr("offset","100%").attr("stop-color","var(--node-grad-b)");

container.append("div").attr("class","legend").text("Edge width ∝ cosine similarity");
container.append("div").attr("class","hint").text("Scroll to zoom • Drag to pan • Click link for Why");
const tooltip = container.append("div").attr("class","tooltip");

let sim = d3.forceSimulation([])
  .force("link", d3.forceLink([]).id(d=>d.id).distance(120))
  .force("charge", d3.forceManyBody().strength(-360))
  .force("center", d3.forceCenter(width/2, height/2))
  .force("collision", d3.forceCollide().radius(34));

let linkSel = g.append("g").attr("class","links").selectAll("line");
let nodeSel = g.append("g").attr("class","nodes").selectAll("g");

const zoom = d3.zoom().scaleExtent([0.5, 2.5]).on("zoom", (event)=> g.attr("transform", event.transform));
svg.call(zoom);
svg.on("dblclick.zoom", null);
svg.on("dblclick", () => svg.transition().duration(250).call(zoom.transform, d3.zoomIdentity));
svg.attr("viewBox", [0,0,width,height]);

function drawGraph(){
  const nodes = documents.map(d => ({ id:d.id, title:d.name }));
  const maxVal = links.length ? d3.max(links, d=>d.value) : 1;
  const strokeScale = d3.scaleLinear().domain([0, maxVal]).range([1.2, 6]);

  linkSel = linkSel.data(links, d => (d.source.id||d.source) + '-' + (d.target.id||d.target));
  linkSel.exit().remove();
  const linkEnter = linkSel.enter().append("line")
    .attr("class","link")
    .attr("stroke-width", d=>strokeScale(d.value))
    .attr("stroke-linecap","round")
    .on("mouseenter", function(event,d){
      d3.select(this).classed("active", true);
      const [mx,my] = d3.pointer(event, container.node());
      tooltip.style("left", mx+14+"px").style("top", my+14+"px")
        .html('<strong>'+idToName(d.source)+' ↔ '+idToName(d.target)+'</strong><br/>Similarity: '+d.value.toFixed(3))
        .classed("show", true);
    })
    .on("mouseleave", function(){ d3.select(this).classed("active", false); tooltip.classed("show", false); });
  linkSel = linkEnter.merge(linkSel).attr("stroke-width", d=>strokeScale(d.value));

  nodeSel = nodeSel.data(nodes, d => d.id);
  nodeSel.exit().remove();
  const nodeEnter = nodeSel.enter().append("g").attr("class","node").call(drag(sim));
  nodeEnter.append("circle").attr("r",22);
  nodeEnter.append("text");
  nodeEnter.insert("rect", "text").attr("class", "node-label-bg");
  nodeEnter.on("mouseenter", function(event, d){
    linkSel.classed("active", l => (l.source.id||l.source)===d.id || (l.target.id||l.target)===d.id);
  }).on("mouseleave", function(){ linkSel.classed("active", false); })
  .on("click", (event, d)=> {
    const doc = documents.find(x => x.id===d.id);
    if(doc){ expandedDocId = (expandedDocId === doc.id ? null : doc.id); renderDocList(); }
  });
  nodeSel = nodeEnter.merge(nodeSel);
  updateNodeLabels(nodeSel);

  sim.nodes(nodes).on("tick", ()=>{
    linkSel
      .attr("x1", d=> nodeById(d.source).x)
      .attr("y1", d=> nodeById(d.source).y)
      .attr("x2", d=> nodeById(d.target).x)
      .attr("y2", d=> nodeById(d.target).y);
    nodeSel.attr("transform", d=>'translate('+d.x+','+d.y+')');
  });
  sim.force("link").links(links);
  sim.alpha(0.8).restart();
}

function nodeById(id){ const k = (id.id || id); return sim.nodes().find(n => n.id === k); }
function idToName(id){ const k = (id.id || id); const doc = documents.find(d => d.id === k); return doc ? doc.name : k; }
function abbrev(name){ if(name.length <= 12) return name; const parts = name.split('.'); const base = parts[0]; return base.length > 10 ? base.slice(0,10) + '…' : base; }

const LABEL_PAD_X = 8, LABEL_PAD_Y = 4, LABEL_CORNER = 8;
function updateNodeLabels(selection){
  selection.each(function(d){
    const group = d3.select(this);
    const textSel = group.select("text").text(abbrev(d.title));
    const textNode = textSel.node();
    if(!textNode) return;
    const bbox = textNode.getBBox();
    group.select("rect.node-label-bg")
      .attr("x", bbox.x - LABEL_PAD_X)
      .attr("y", bbox.y - LABEL_PAD_Y)
      .attr("width", bbox.width + LABEL_PAD_X * 2)
      .attr("height", bbox.height + LABEL_PAD_Y * 2)
      .attr("rx", LABEL_CORNER).attr("ry", LABEL_CORNER);
  });
}

// Drag helpers
function drag(simulation){
  return d3.drag()
    .on("start", (event,d)=>{ if (!event.active) simulation.alphaTarget(0.3).restart(); d.fx = d.x; d.fy = d.y; })
    .on("drag", (event,d)=>{ d.fx = event.x; d.fy = event.y; })
    .on("end", (event,d)=>{ if (!event.active) simulation.alphaTarget(0); d.fx = null; d.fy = null; });
}

// Seed sample files
(function seed(){
  const examples = [
    {name:"Alpha.txt", text:"Alpha guideline for compliance and risk management. This document outlines policies for data handling and third party oversight. Encryption standards and key rotation are mandatory. Vendors must provide incident reporting within 24 hours."},
    {name:"Beta.txt", text:"Beta policy describes operational risk controls and internal audit procedures. Focus on incident reporting and remediation actions. Vendors and outsourcing oversight require encryption and access reviews with key rotation."},
    {name:"Gamma.txt", text:"Gamma standard: information security, data privacy controls, encryption standards, key rotation, user access reviews. Monitoring and alerting thresholds are defined for privileged accounts."},
    {name:"Delta.txt", text:"Delta procedure: vendor due diligence, outsourcing oversight, service level monitoring, business continuity planning. Incident drill exercises ensure response readiness within 24 hours."},
    {name:"Epsilon.txt", text:"Epsilon memo summarizing lessons learned from incidents, near misses, fraud attempts, and conduct breaches. Recommendations include stronger encryption, faster vendor incident reporting, and clearer escalation thresholds."}
  ];
  for(const f of examples){ addDocument(f.name, f.text); }
  recomputeLinks(); drawGraph(); renderDocList();
})();

// Resize handling
window.addEventListener('resize', () => {
  const w = container.node().clientWidth;
  const h = container.node().clientHeight;
  svg.attr("viewBox", [0, 0, w, h]);
  sim.force("center", d3.forceCenter(w/2, h/2));
  sim.alpha(0.3).restart();
});
</script>
</body>
</html>
