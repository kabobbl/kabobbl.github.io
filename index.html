<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Document Network — Refined View Toggle</title>

<!-- D3.js -->
<script src="https://d3js.org/d3.v7.min.js"></script>

<!-- Google Font -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
  :root{
    --bg-grad-1:#f8fafc;
    --bg-grad-2:#eef2f7;
    --card-bg:#ffffff;
    --link:#64748b;
    --link-active:#0ea5e9;
    --node-grad-a:#0ea5e9;
    --node-grad-b:#6366f1;
    --text:#0f172a;
    --muted:#475569;
    --accent:#0ea5e9;
    --border: rgba(15,23,42,.10);
    --shadow-1: 0 10px 30px rgba(2,8,20,.06), 0 2px 8px rgba(2,8,20,.06);
    --shadow-2: 0 6px 16px rgba(14,165,233,.35);
    --chip-bg:#fff;
    --chip-border: rgba(15,23,42,.12);
    --pill-bg:#fff;
  }
  .theme-dark{
    --bg-grad-1:#0b1220;
    --bg-grad-2:#0b0f1a;
    --card-bg:#0e1626;
    --link:#7a8aa3;
    --link-active:#38bdf8;
    --node-grad-a:#22d3ee;
    --node-grad-b:#6366f1;
    --text:#e5e7eb;
    --muted:#9aa3b2;
    --accent:#38bdf8;
    --border: rgba(148,163,184,.18);
    --shadow-1: 0 10px 30px rgba(0,0,0,.35), 0 2px 8px rgba(0,0,0,.25);
    --shadow-2: 0 6px 16px rgba(56,189,248,.35);
    --chip-bg:#0b1322;
    --chip-border: rgba(148,163,184,.22);
    --pill-bg:#0b1322;
  }

  html, body { height:100%; }

  body {
    margin:0;
    font-family:'Inter', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    color:var(--text);
    background:linear-gradient(135deg, var(--bg-grad-1), var(--bg-grad-2));
  }

  .layout {
    display:grid;
    grid-template-columns: 360px 1fr;
    grid-template-rows: auto 1fr;
    grid-template-areas:
      "header header"
      "sidebar main";
    height:100vh;
    gap:14px;
    padding:16px;
    box-sizing:border-box;
    transition:grid-template-columns .22s ease;
  }

  /* Full Document Library mode */
  body.doclib-full .layout{
    grid-template-columns: 1fr 0;
  }
  body.doclib-full .main{ display:none; }
  body.doclib-full .sidebar{ box-shadow:var(--shadow-1); }

  .header {
    grid-area:header;
    display:flex; align-items:center; justify-content:space-between; gap:12px;
  }

  .brand { font-weight:700; font-size:18px; letter-spacing:.2px; }
  .controls { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }

  .search {
    display:flex; align-items:center; gap:8px;
    background:var(--card-bg); border:1px solid var(--border);
    border-radius:10px; padding:8px 10px;
    box-shadow:var(--shadow-1);
  }
  .search input{
    border:none; outline:none; font-size:13px; width:220px; background:transparent; color:var(--text);
  }
  .search svg path{ stroke:var(--muted); }

  /* Threshold control (kept in place but disabled in Library view) */
  .range {
    background:var(--card-bg); border:1px solid var(--border);
    border-radius:10px; padding:6px 10px;
    display:flex; align-items:center; gap:8px; font-size:12px;
    box-shadow:var(--shadow-1); color:var(--text);
    min-width: 260px; /* keeps width consistent when dimmed */
  }
  .range input[type=range]{ width:160px; }
  .range.disabled { opacity:.45; pointer-events:none; }

  .btn {
    background:var(--accent); color:#001018; border:none; border-radius:10px;
    padding:10px 12px; font-weight:600; cursor:pointer;
    box-shadow:var(--shadow-2);
  }
  .btn.ghost{ background:transparent; color:var(--text); border:1px solid var(--border); box-shadow:none; }

  .icon-btn{
    display:flex; align-items:center; gap:8px;
    background:var(--card-bg); color:var(--text); border:1px solid var(--border);
    border-radius:10px; padding:8px 10px; cursor:pointer; box-shadow:var(--shadow-1);
  }
  .icon-btn svg path, .icon-btn svg circle{ stroke:var(--text); }

  /* Refined View Toggle: compact pill with icon & target label */
  #viewToggleBtn{
    display:flex; align-items:center; gap:8px;
    padding:8px 12px; border-radius:999px;
    border:1px solid var(--border);
    background:var(--card-bg);
    box-shadow:var(--shadow-1);
    font-weight:700; cursor:pointer;
  
    width: 240px; /* keep size constant regardless of label length */
    justify-content: center;
    white-space: nowrap;
  }
  #viewToggleBtn .target{ font-size:12px; }
  #viewToggleBtn .sep{ opacity:.35; }
  #viewToggleBtn .hint{ font-size:11px; color:var(--muted); }

  /* Light mode gradient for key buttons */
  body:not(.theme-dark) #viewToggleBtn,
  body:not(.theme-dark) #fileBtn{
    background: linear-gradient(135deg, var(--node-grad-a), var(--node-grad-b));
    color:#fff;
    border:none;
    box-shadow: 0 4px 12px rgba(14,165,233,.35);
  }
  body:not(.theme-dark) #viewToggleBtn .hint{ color:rgba(255,255,255,.85); }
  body:not(.theme-dark) #viewToggleBtn svg path,
  body:not(.theme-dark) #viewToggleBtn svg circle{ stroke:#fff; }

  .sidebar {
    grid-area:sidebar;
    background:var(--card-bg);
    border-radius:14px;
    box-shadow:var(--shadow-1);
    overflow:hidden;
    display:flex; flex-direction:column;
  }
  .side-head {
    padding:12px 14px; border-bottom:1px solid var(--border);
    display:flex; align-items:center; justify-content:space-between; gap:8px;
  }
  .side-title { font-weight:600; display:flex; align-items:center; gap:8px; }

  .drop {
    margin:12px; padding:16px; border:1.5px dashed var(--border);
    border-radius:12px; background:rgba(255,255,255,.04);
    text-align:center; font-size:13px; color:var(--muted);
  }
  .theme-dark .drop{ background:rgba(255,255,255,.02); }
  .drop.dragover { border-color:var(--accent); background:rgba(14,165,233,.08); color:var(--accent); }

  .docs { overflow:auto; padding:6px 6px 12px 6px; }
  .doc {
    border:1px solid var(--border); background:var(--card-bg); border-radius:12px;
    padding:10px; margin:8px; cursor:pointer;
    transition:box-shadow .15s ease, border-color .15s ease, background .15s ease;
  }
  .doc:hover{ border-color:rgba(14,165,233,.5); box-shadow:0 2px 10px rgba(14,165,233,.12); }
  .doc .row { display:flex; align-items:center; justify-content:space-between; gap:8px; }
  .doc .name { font-weight:600; font-size:13px; color:var(--text); }
  .doc .meta { color:var(--muted); font-size:12px; margin-top:4px; }
  .caret{ transition:transform .18s ease; }
  .doc.expanded .caret{ transform:rotate(90deg); }

  .doc-meta-inline{
    margin:8px 8px 4px 8px; background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    border:1px solid var(--border);
    border-radius:12px; padding:12px; color:var(--text);
  }
  .grid {
    display:grid; grid-template-columns: 1fr 1fr; gap:8px 12px; margin-top:8px;
  }
  .field {
    background:var(--card-bg); border:1px solid var(--border);
    border-radius:8px; padding:8px;
  }
  .field .label { font-size:11px; color:var(--muted); }
  .field .value { font-weight:600; margin-top:2px; color:var(--text); }

  .subtle { color:var(--muted); font-size:12px; }
  .chips{ display:flex; gap:6px; flex-wrap:wrap; margin-top:8px; }
  .chip{ padding:4px 8px; background:var(--chip-bg); border:1px solid var(--chip-border); border-radius:999px; font-size:12px; cursor:pointer; color:var(--text); }
  .chip:hover{ border-color:var(--accent); }

  .main {
    grid-area:main;
    position:relative;
    background:var(--card-bg);
    border-radius:14px;
    box-shadow:var(--shadow-1);
    overflow:hidden;
    min-height:320px;
  }

  .tooltip{
    position:absolute;
    pointer-events:none;
    padding:10px 12px;
    background:var(--card-bg);
    color:var(--text);
    border-radius:10px;
    font-size:13px;
    line-height:1.45;
    box-shadow:var(--shadow-1);
    opacity:0;
    transform:translateY(-2px);
    transition:opacity .16s ease, transform .16s ease;
    max-width:240px;
    border:1px solid var(--border);
    white-space:pre-wrap;
  }
  .tooltip.show{ opacity:1; transform:translateY(0); }

  .link{ stroke:var(--link); opacity:.45; transition:opacity .2s, stroke .2s, stroke-width .2s; }
  .link.active{ stroke:var(--link-active); opacity:.95; }

  .node circle{
    fill:url(#nodeGradient);
    stroke:#fff; stroke-width:2px;
    filter:drop-shadow(0 2px 5px rgba(2,8,20,.2));
    transition:r .2s ease, filter .2s ease;
  }
  .theme-dark .node circle{ stroke:rgba(255,255,255,.8); }

  .node text{ font-size:13px; font-weight:600; fill:#fff; text-anchor:middle; dominant-baseline:central; pointer-events:none; }
  .node-label-bg{
    fill:rgba(15,23,42,.7);
    stroke:rgba(255,255,255,.35);
    stroke-width:.6px;
    pointer-events:none;
  }
  .legend{
    position:absolute; left:12px; bottom:10px;
    background:rgba(255,255,255,.85);
    border:1px solid var(--border);
    backdrop-filter:saturate(140%) blur(6px);
    padding:6px 10px; border-radius:8px; font-size:12px; color:#0f172a;
  }
  .theme-dark .legend{
    background:rgba(15,23,42,.65);
    color:#e5e7eb;
  }
  .hint{
    position:absolute; right:12px; bottom:10px;
    font-size:12px; color:var(--muted);
    background:rgba(255,255,255,.85); border:1px solid var(--border);
    padding:6px 10px; border-radius:8px;
  }
  .theme-dark .hint{
    background:rgba(15,23,42,.65);
    color:#e5e7eb;
  }

  .why-panel {
    position:absolute; top:12px; right:12px; width:420px;
    background:var(--card-bg); border:1px solid var(--border); border-radius:12px;
    box-shadow:var(--shadow-1);
    padding:12px; font-size:13px; display:none;
    max-height:80vh; overflow:auto; color:var(--text);
  }
  .why-panel h4{ margin:4px 0 8px 0; font-size:14px; }
  .why-panel .close{ float:right; cursor:pointer; color:var(--muted); }
  .match-card{
    border:1px solid var(--border);
    border-radius:10px; padding:10px; margin:8px 0; background:var(--card-bg); color:var(--text);
  }
  .pair-head{ display:flex; justify-content:space-between; align-items:center; gap:8px; }
  .pair-head .score{ font-weight:600; }
  .pair-texts{ display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-top:8px; }
  .pair-text{ font-size:12px; line-height:1.45; background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02)); border:1px solid var(--border); border-radius:8px; padding:8px; max-height:140px; overflow:auto; color:var(--text); }
  .pair-meta{ margin-top:6px; color:var(--muted); font-size:11px; display:flex; gap:8px; flex-wrap:wrap; }
  .pair-actions{ margin-top:8px; display:flex; gap:8px; }
  mark{ background:#fde68a; padding:0 2px; border-radius:3px; }

  .modal {
    position:fixed; inset:0; background:rgba(2,8,20,.55);
    display:none; align-items:center; justify-content:center; padding:24px;
  }
  .modal .inner{
    width:min(1100px, 96vw); max-height:90vh; background:var(--card-bg); color:var(--text); border-radius:14px;
    box-shadow:0 20px 60px rgba(2,8,20,.4); overflow:hidden; display:flex; flex-direction:column;
  }
  .modal .bar{
    display:flex; justify-content:space-between; align-items:center; padding:12px 14px;
    border-bottom:1px solid var(--border);
  }
  .modal .content{
    display:grid; grid-template-columns: 1fr 1fr; gap:0; flex:1; overflow:auto;
  }
  .side{
    padding:14px; border-right:1px solid var(--border);
  }
  .side:last-child{ border-right:none; }
  .side h5{ margin:0 0 6px 0; font-size:13px; }
  .excerpt{
    background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02)); border:1px solid var(--border);
    border-radius:10px; padding:10px; font-size:13px; line-height:1.55; white-space:pre-wrap; color:var(--text);
  }
</style>
</head>

<body>
  <div class="layout">
    <div class="header">
      <div class="brand">Document Network</div>
      <div class="controls">
        <!-- Search -->
        <div class="search">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15z" stroke="#64748b" stroke-width="2" stroke-linecap="round"/></svg>
          <input id="searchInput" placeholder="Search documents..." />
        </div>

        <!-- Link Threshold -->
        <div class="range" id="rangeWrap">
          <span>Link threshold</span>
          <input type="range" id="threshold" min="0" max="100" value="30" />
          <span id="thLabel">0.30</span>
        </div>

        <!-- Refined toggle placed to the RIGHT of Link Threshold; static position in both views -->
        <button id="viewToggleBtn" class="icon-btn" aria-pressed="false" title="Switch to Document Library" aria-keyshortcuts="v">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path id="viewIcon" d="M3 12h18M3 6h12M3 18h12" stroke-width="2" stroke-linecap="round"/>
          </svg>
          <span class="target" id="viewToggleTarget">Current View: Diagram</span>
          <span class="sep">•</span>
          <span class="hint">press V</span>
        </button>

        <button class="btn" id="fileBtn">Add documents</button>
        <input type="file" id="fileInput" multiple style="display:none" accept=".txt,.md,.pdf,.docx,.html,.csv"/>

        <!-- Theme toggle -->
        <button class="icon-btn" id="themeBtn" aria-pressed="false" title="Toggle light/dark mode">
          <svg id="themeIcon" width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <circle cx="12" cy="12" r="4" stroke-width="2" />
            <path d="M12 2v2M12 20v2M4 12H2M22 12h-2M5 5l1.5 1.5M17.5 17.5L19 19M5 19l1.5-1.5M17.5 6.5L19 5" stroke-width="2" stroke-linecap="round"/>
          </svg>
          <span id="themeLabel" style="font-weight:600;font-size:12px;">Light</span>
        </button>
      </div>
    </div>

    <!-- Sidebar / Document Library -->
    <aside class="sidebar">
      <div class="side-head">
        <div class="side-title">
          <span>Documents</span>
        </div>
        <div class="subtle" id="docCount">0 items</div>
      </div>
      <div class="drop" id="dropZone">
        Drop files here (.txt/.md recommended for demo).<br/>Or click “Add documents”.
      </div>
      <div class="docs" id="docList" aria-live="polite"></div>
    </aside>

    <!-- Main graph (Diagram view) -->
    <main class="main" id="graph"></main>
  </div>

<!-- Why panel -->
<div class="why-panel" id="whyPanel">
  <span class="close" id="whyClose">✕</span>
  <h4>Why these documents link?</h4>
  <div id="whyHeader" class="subtle" style="margin-bottom:8px;"></div>
  <div id="whyContent"></div>
</div>

<!-- Modal viewer -->
<div class="modal" id="viewerModal" role="dialog" aria-modal="true">
  <div class="inner">
    <div class="bar">
      <div id="viewerTitle" style="font-weight:600;">Passage viewer</div>
      <button class="btn ghost" id="viewerClose">Close</button>
    </div>
    <div class="content">
      <div class="side">
        <h5 id="leftTitle">A</h5>
        <div class="excerpt" id="leftExcerpt"></div>
      </div>
      <div class="side">
        <h5 id="rightTitle">B</h5>
        <div class="excerpt" id="rightExcerpt"></div>
      </div>
    </div>
  </div>
</div>

<script>
// ------------------------------ Theme: init & toggle ------------------------------
(function initTheme(){
  const saved = localStorage.getItem('docnet-theme');
  const preferDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
  const startDark = saved ? (saved === 'dark') : preferDark;
  if(startDark) document.body.classList.add('theme-dark');
  updateThemeButton();
})();

document.getElementById('themeBtn').addEventListener('click', () => {
  document.body.classList.toggle('theme-dark');
  const dark = document.body.classList.contains('theme-dark');
  localStorage.setItem('docnet-theme', dark ? 'dark' : 'light');
  updateThemeButton();
});

function updateThemeButton(){
  const dark = document.body.classList.contains('theme-dark');
  const label = document.getElementById('themeLabel');
  const icon = document.getElementById('themeIcon');
  label.textContent = dark ? 'Dark' : 'Light';
  document.getElementById('themeBtn').setAttribute('aria-pressed', dark ? 'true' : 'false');
  if(dark){
    icon.innerHTML = `<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>`;
  } else {
    icon.innerHTML = `<circle cx="12" cy="12" r="4" stroke-width="2" /><path d="M12 2v2M12 20v2M4 12H2M22 12h-2M5 5l1.5 1.5M17.5 17.5L19 19M5 19l1.5-1.5M17.5 6.5L19 5" stroke-width="2" stroke-linecap="round"/>`;
  }
}

// ------------------------------ Helpers: tokenization & TF-IDF ------------------------------
const stopwords = new Set("a,an,and,are,as,at,be,by,for,from,has,he,in,is,it,its,of,on,that,the,to,was,were,will,with,or,not,if,then,into,over,under,between,than,about,after,before,again,once,only,other,own,same,so,too,very,can,just,should,now".split(","));

function tokenize(text){
  return (text||"")
    .toLowerCase()
    .replace(/[\\u2018\\u2019\\u201C\\u201D]/g, "'")
    .replace(/[^a-z0-9\\s]/g, " ")
    .split(/\\s+/)
    .filter(t => t && !stopwords.has(t) && t.length > 1);
}
function tf(tokens){
  const map = new Map();
  tokens.forEach(t => map.set(t, (map.get(t)||0)+1));
  const N = tokens.length || 1;
  for(const [k,v] of map) map.set(k, v/N);
  return map;
}
function idf(allDocs){
  const df = new Map(); const N = allDocs.length || 1;
  for(const doc of allDocs){
    const unique = new Set(doc.tokens);
    unique.forEach(t => df.set(t, (df.get(t)||0)+1));
  }
  const idfMap = new Map();
  for(const [t, dfi] of df) idfMap.set(t, Math.log((N+1)/(dfi+1)) + 1);
  return idfMap;
}
function tfidfVec(tfMap, idfMap){
  const vec = new Map();
  for(const [t, w] of tfMap){
    if(idfMap.has(t)) vec.set(t, w * idfMap.get(t));
  }
  return vec;
}
function cosineSim(vecA, vecB){
  let dot=0, normA=0, normB=0;
  for(const [t, w] of vecA){
    if(vecB.has(t)) dot += w * vecB.get(t);
    normA += w*w;
  }
  for(const [, w] of vecB){ normB += w*w; }
  const denom = Math.sqrt(normA) * Math.sqrt(normB);
  return denom ? dot/denom : 0;
}

// sentence split keeping indices
function splitSentences(text){
  const out = [];
  let start = 0;
  const re = /([^.!?]+[.!?])|([^\\n]+(\\n|$))/g;
  let m;
  while ((m = re.exec(text)) !== null){
    const s = m[0].trim();
    if(s.length < 3) continue;
    const idx = text.indexOf(s, start);
    const end = idx + s.length;
    out.push({ text: s, start: idx, end: end });
    start = end;
  }
  if(out.length === 0 && text) out.push({ text, start:0, end:text.length });
  return out;
}

function escapeHtml(s){ return s.replace(/[&<>\"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\\\"":"&quot;","'":"&#39;" }[m])); }
function highlightTerms(text, terms){
  let esc = escapeHtml(text);
  const uniq = Array.from(new Set(terms)).sort((a,b)=>b.length - a.length);
  for(const t of uniq){
    if(!t || t.length < 2) continue;
    const re = new RegExp(`\\\\b${t.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&')}\\\\b`, 'gi');
    esc = esc.replace(re, m => `<mark>${m}</mark>`);
  }
  return esc;
}

// Governance placeholders and extra metadata
const OWNER_NAMES = ["Alex Morgan","Priya Nair","Liam O'Connor","Sofia Rossi","Chen Wei","Amira Haddad","Jonas Müller","Isabella García"];
const APPROVER_NAMES = ["Maya Patel","Tom Andersen","Noah Brown","Olivia Martin","Hiro Tanaka","Grace Lee","Samuel Kim","Ava Thompson"];
const TOPICS = ["Information Security","Operational Risk","Vendor Oversight","Business Continuity","Privacy","Access Management","Incident Response","Audit"];

function pick(arr, seed){ return arr[seed % arr.length]; }
function formatDate(d){
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}
function fakeGovernance(seed){
  const now = new Date();
  const monthsBack = (seed % 18) + 1;
  const eff = new Date(now); eff.setMonth(eff.getMonth() - monthsBack);
  const next = new Date(eff); next.setMonth(next.getMonth() + 12);
  return {
    owner: pick(OWNER_NAMES, seed),
    approver: pick(APPROVER_NAMES, seed+3),
    effectiveDate: formatDate(eff),
    nextApprovalDate: formatDate(next),
    topic: pick(TOPICS, seed+5)
  };
}

// ------------------------------ App state ------------------------------
let documents = [];
let links = [];
let idCounter = 1;

// ------------------------------ UI elements ------------------------------
const fileBtn = document.getElementById('fileBtn');
const fileInput = document.getElementById('fileInput');
const dropZone = document.getElementById('dropZone');
const docList = document.getElementById('docList');
const docCount = document.getElementById('docCount');
const searchInput = document.getElementById('searchInput');
const thresholdEl = document.getElementById('threshold');
const thLabel = document.getElementById('thLabel');
const whyPanel = document.getElementById('whyPanel');
const whyClose = document.getElementById('whyClose');
const whyHeader = document.getElementById('whyHeader');
const whyContent = document.getElementById('whyContent');
const rangeWrap = document.getElementById('rangeWrap');
const viewToggleBtn = document.getElementById('viewToggleBtn');
const viewToggleTarget = document.getElementById('viewToggleTarget');
const viewIcon = document.getElementById('viewIcon');

whyClose.addEventListener('click', ()=> whyPanel.style.display='none');

fileBtn.addEventListener('click', ()=>fileInput.click());
fileInput.addEventListener('change', (e)=> handleFiles(e.target.files));

['dragenter','dragover'].forEach(ev => dropZone.addEventListener(ev, (e)=>{
  e.preventDefault(); e.stopPropagation(); dropZone.classList.add('dragover');
}));
['dragleave','drop'].forEach(ev => dropZone.addEventListener(ev, (e)=>{
  e.preventDefault(); e.stopPropagation(); dropZone.classList.remove('dragover');
}));
dropZone.addEventListener('drop', (e)=> handleFiles(e.dataTransfer.files));

searchInput.addEventListener('input', renderDocList);
thresholdEl.addEventListener('input', () => { 
  thLabel.textContent = (thresholdEl.value/100).toFixed(2); 
  recomputeLinks(); drawGraph(); 
});

// -------------- Refined View Toggle Logic --------------
function applyView(mode){
  const isLibrary = (mode === 'library');
  document.body.classList.toggle('doclib-full', isLibrary);
  viewToggleBtn.setAttribute('aria-pressed', isLibrary ? 'true' : 'false');
  // keep toggle in same spot; only dim threshold
  rangeWrap.classList.toggle('disabled', isLibrary);
  // target label indicates what you'll go TO next
  viewToggleTarget.textContent = isLibrary ? 'Current View: Library' : 'Current View: Diagram';
  viewToggleBtn.title = isLibrary ? 'Switch to Diagram' : 'Switch to Document Library';
  // swap icon (list for library target, graph for diagram target)
  if(isLibrary){
    viewIcon.setAttribute('d','M4 4h16v6H4zM4 14h16v6H4z'); // stacked rows = diagram target? flip: we want icon for target
  } else {
    viewIcon.setAttribute('d','M3 12h18M3 6h12M3 18h12'); // list icon when target is library
  }
  localStorage.setItem('docnet-view', mode);
}
function toggleView(){
  const isLibrary = document.body.classList.contains('doclib-full');
  applyView(isLibrary ? 'diagram' : 'library');
}
viewToggleBtn.addEventListener('click', toggleView);
document.addEventListener('keydown', (e) => {
  if(e.key.toLowerCase()==='v' && !e.metaKey && !e.ctrlKey && !e.altKey){
    e.preventDefault(); toggleView();
  }
});
// init from storage
(function initView(){
  const saved = localStorage.getItem('docnet-view');
  applyView(saved === 'library' ? 'library' : 'diagram');
})();

// ------------------------------ File handling ------------------------------
async function handleFiles(fileList){
  const files = Array.from(fileList||[]);
  for (const file of files){
    const ext = (file.name.split('.').pop()||'').toLowerCase();
    let text = '';
    if (ext === 'txt' || ext === 'md' || ext === 'csv' || ext === 'html'){
      text = await file.text();
    } else if (ext === 'pdf' || ext === 'docx'){
      text = ''; // placeholder for demo
    } else {
      continue;
    }
    addDocument(file.name, text);
  }
  recomputeLinks();
  drawGraph();
  renderDocList();
}

function addDocument(name, text){
  const tokens = tokenize(text);
  const tfMap = tf(tokens);
  const summary = (text||'').split(/\\s+/).slice(0,40).join(' ');
  const sentences = splitSentences(text).map(s => {
    const toks = tokenize(s.text);
    return { ...s, tokens: toks, tf: tf(toks), vec: null };
  });
  const meta = fakeGovernance(idCounter);
  const doc = { 
    id: 'doc' + (idCounter++), name, text, tokens, tf: tfMap, vec:null, summary, sentences,
    owner: meta.owner, approver: meta.approver, effectiveDate: meta.effectiveDate, nextApprovalDate: meta.nextApprovalDate,
    topic: meta.topic, supportIds: [], history: []
  };
  const idx = documents.length;
  if(idx >= 1) doc.supportIds.push(documents[idx-1].id);
  if(idx >= 2) doc.supportIds.push(documents[idx-2].id);
  doc.history = [
    { version: "v" + (1 + Math.floor(Math.random()*2)) + ".0", date: meta.effectiveDate, note: "Initial publication" },
    { version: "v" + (2 + Math.floor(Math.random()*2)) + ".1", date: meta.nextApprovalDate, note: "Scheduled review" }
  ];
  documents.push(doc);
  docCount.textContent = documents.length + ' items';
}

// ------------------------------ Similarity & links ------------------------------
function recomputeLinks(){
  const idfMap = idf(documents.map(d => ({tokens: d.tokens})));
  documents.forEach(d => d.vec = tfidfVec(d.tf, idfMap));

  const threshold = thresholdEl.value/100;
  const out = [];
  for(let i=0;i<documents.length;i++){
    for(let j=i+1;j<documents.length;j++){
      const a = documents[i], b = documents[j];
      const sim = cosineSim(a.vec, b.vec);
      if (sim >= threshold) out.push({ source: a.id, target: b.id, value: sim });
    }
  }
  links = out;
}

// ------------------------------ Sidebar rendering ------------------------------
let expandedDocId = null;
function renderDocList(){
  const q = (searchInput.value||'').toLowerCase();
  const list = document.getElementById('docList');
  list.innerHTML = '';
  documents
    .filter(d => d.name.toLowerCase().includes(q) || (d.text||'').toLowerCase().includes(q))
    .forEach(d => {
      const card = document.createElement('div');
      const isExpanded = (expandedDocId === d.id);
      card.className = 'doc' + (isExpanded ? ' expanded' : '');
      card.setAttribute('role','button');
      card.setAttribute('tabindex','0');
      card.innerHTML = `<div class="row">
                          <div>
                            <div class="name">${d.name}</div>
                            <div class="meta">${d.tokens.length} tokens • Owner: ${d.owner} • Topic: ${d.topic}</div>
                          </div>
                          <svg class="caret" width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                            <path d="M9 6l6 6-6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                          </svg>
                        </div>`;
      const toggle = () => {
        expandedDocId = (expandedDocId === d.id) ? null : d.id;
        renderDocList();
      };
      card.addEventListener('click', toggle);
      card.addEventListener('keypress', (e)=>{ if(e.key==='Enter' || e.key===' '){ toggle(); }});
      list.appendChild(card);

      if (isExpanded){
        const meta = document.createElement('div');
        meta.className = 'doc-meta-inline';

        const supports = (d.supportIds||[]).map(id => {
          const sd = documents.find(x => x.id===id);
          return sd ? `<span class="chip" data-docid="${sd.id}" title="Open ${sd.name}">${sd.name}</span>` : '';
        }).join('');

        const history = (d.history||[]).map(h => `<li><strong>${h.version}</strong> — ${h.date} — <span class="subtle">${h.note}</span></li>`).join('');

        meta.innerHTML = `
          <details open>
            <summary><strong>Governance</strong></summary>
            <div class="grid" style="margin-top:8px;">
              <div class="field"><div class="label">Topic</div><div class="value">${d.topic}</div></div>
              <div class="field"><div class="label">Owner</div><div class="value">${d.owner}</div></div>
              <div class="field"><div class="label">Effective Date</div><div class="value">${d.effectiveDate}</div></div>
              <div class="field"><div class="label">Next Approval Date</div><div class="value">${d.nextApprovalDate}</div></div>
            </div>
          </details>
          <details style="margin-top:10px;" open>
            <summary><strong>Supporting Documents</strong></summary>
            <div class="chips" style="margin-top:8px;">${supports || '<span class="subtle">None</span>'}</div>
          </details>
          <details style="margin-top:10px;">
            <summary><strong>Document History</strong></summary>
            <ul style="margin:8px 0 0 16px; padding:0;">${history || '<li class="subtle">No history</li>'}</ul>
          </details>
          <details style="margin-top:10px;">
            <summary><strong>Summary</strong></summary>
            <div class="subtle" style="margin-top:8px;">${d.summary || '<em>No preview for this file type in demo.</em>'}</div>
          </details>
        `;
        meta.querySelectorAll('.chip').forEach(ch => {
          ch.addEventListener('click', () => {
            const id = ch.getAttribute('data-docid');
            expandedDocId = id;
            renderDocList();
          });
        });
        list.appendChild(meta);
      }
    });
}

// ------------------------------ Graph (D3) ------------------------------
const container = d3.select("#graph");
const width  = container.node().clientWidth;
const height = container.node().clientHeight;

const svg = container.append("svg");
const g = svg.append("g");

const defs = svg.append("defs");
const grad = defs.append("linearGradient")
  .attr("id","nodeGradient").attr("x1","0%").attr("y1","0%").attr("x2","100%").attr("y2","100%");
grad.append("stop").attr("offset","0%").attr("stop-color","var(--node-grad-a)");
grad.append("stop").attr("offset","100%").attr("stop-color","var(--node-grad-b)");

container.append("div").attr("class","legend").text("Edge width ∝ cosine similarity");
container.append("div").attr("class","hint").text("Scroll to zoom • Drag to pan • Click link for Why");
const tooltip = container.append("div").attr("class","tooltip");

let sim = d3.forceSimulation([])
  .force("link", d3.forceLink([]).id(d=>d.id).distance(120))
  .force("charge", d3.forceManyBody().strength(-360))
  .force("center", d3.forceCenter(width/2, height/2))
  .force("collision", d3.forceCollide().radius(34));

let linkSel = g.append("g").attr("class","links").selectAll("line");
let nodeSel = g.append("g").attr("class","nodes").selectAll("g");

const zoom = d3.zoom().scaleExtent([0.5, 2.5]).on("zoom", (event)=> g.attr("transform", event.transform));
svg.call(zoom);
svg.on("dblclick.zoom", null);
svg.on("dblclick", () => svg.transition().duration(250).call(zoom.transform, d3.zoomIdentity));
svg.attr("viewBox", [0,0,width,height]);

function drawGraph(){
  const nodes = documents.map(d => ({ id:d.id, title:d.name }));
  const maxVal = links.length ? d3.max(links, d=>d.value) : 1;
  const strokeScale = d3.scaleLinear().domain([0, maxVal]).range([1.2, 6]);

  linkSel = linkSel.data(links, d => d.source + '-' + d.target);
  linkSel.exit().remove();
  const linkEnter = linkSel.enter().append("line")
    .attr("class","link")
    .attr("stroke-width", d=>strokeScale(d.value))
    .attr("stroke-linecap","round")
    .on("click", (event,d)=> showWhyForEdge(d))
    .on("mouseenter", function(event,d){
      d3.select(this).classed("active", true);
      const [mx,my] = d3.pointer(event, container.node());
      tooltip.style("left", mx+14+"px").style("top", my+14+"px")
        .html(`<strong>${idToName(d.source)} ↔ ${idToName(d.target)}</strong><br/>Similarity: ${d.value.toFixed(3)}`)
        .classed("show", true);
    })
    .on("mouseleave", function(){
      d3.select(this).classed("active", false);
      tooltip.classed("show", false);
    });
  linkSel = linkEnter.merge(linkSel)
    .attr("stroke-width", d=>strokeScale(d.value));

  nodeSel = nodeSel.data(nodes, d => d.id);
  nodeSel.exit().remove();
  const nodeEnter = nodeSel.enter().append("g").attr("class","node").call(drag(sim));
  nodeEnter.append("circle").attr("r",22);
  nodeEnter.append("text");
  nodeEnter.insert("rect", "text").attr("class", "node-label-bg");
  nodeEnter.on("mouseenter", function(event, d){
    linkSel.classed("active", l => l.source.id===d.id || l.target.id===d.id);
  }).on("mouseleave", function(){
    linkSel.classed("active", false);
  }).on("click", (event, d)=> {
    const doc = documents.find(x => x.id===d.id);
    if(doc){ 
      expandedDocId = (expandedDocId === doc.id ? null : doc.id); 
      // do NOT switch views; only reveal/refresh metadata panel
      renderDocList();
    }
  });
  nodeSel = nodeEnter.merge(nodeSel);
  updateNodeLabels(nodeSel);

  sim.nodes(nodes).on("tick", ()=>{
    linkSel
      .attr("x1", d=> nodeById(d.source).x)
      .attr("y1", d=> nodeById(d.source).y)
      .attr("x2", d=> nodeById(d.target).x)
      .attr("y2", d=> nodeById(d.target).y);
    nodeSel.attr("transform", d=>`translate(${d.x},${d.y})`);
  });
  sim.force("link").links(links);
  sim.alpha(0.8).restart();
}

function nodeById(id){ return sim.nodes().find(n => n.id === (id.id || id)); }
function idToName(id){
  const doc = documents.find(d => d.id === (id.id || id));
  return doc ? doc.name : id;
}
function abbrev(name){
  if(name.length <= 12) return name;
  const parts = name.split('.');
  const base = parts[0];
  return base.length > 10 ? base.slice(0,10) + '…' : base;
}

const LABEL_PAD_X = 8;
const LABEL_PAD_Y = 4;
const LABEL_CORNER = 8;

function updateNodeLabels(selection){
  selection.each(function(d){
    const group = d3.select(this);
    const textSel = group.select("text").text(abbrev(d.title));
    const textNode = textSel.node();
    if(!textNode) return;
    const bbox = textNode.getBBox();
    group.select("rect.node-label-bg")
      .attr("x", bbox.x - LABEL_PAD_X)
      .attr("y", bbox.y - LABEL_PAD_Y)
      .attr("width", bbox.width + LABEL_PAD_X * 2)
      .attr("height", bbox.height + LABEL_PAD_Y * 2)
      .attr("rx", LABEL_CORNER)
      .attr("ry", LABEL_CORNER);
  });
}

// ------------------------------ Why panel rendering ------------------------------
function showWhyForEdge(edge){
  const a = documents.find(d => d.id === (edge.source.id || edge.source));
  const b = documents.find(d => d.id === (edge.target.id || edge.target));
  if(!a || !b) return;

  const pairs = computePairs(a, b, {k:10, threshold:0.3});
  document.getElementById('whyHeader').textContent = `${a.name} ↔ ${b.name} • doc sim ${edge.value.toFixed(3)}`;

  whyContent.innerHTML = '';
  pairs.forEach((p, idx) => {
    const shared = p.overlap.shared_terms || [];
    const aHtml = highlightTerms(p.a.text, shared);
    const bHtml = highlightTerms(p.b.text, shared);
    const card = document.createElement('div');
    card.className = 'match-card';
    card.innerHTML = `
      <div class="pair-head">
        <div class="score">Match #${idx+1} • score ${p.score.toFixed(3)}</div>
        <div class="subtle">${shared.slice(0,6).join(', ')}</div>
      </div>
      <div class="pair-texts">
        <div class="pair-text">${aHtml}</div>
        <div class="pair-text">${bHtml}</div>
      </div>
    `;
    whyContent.appendChild(card);
  });

  document.getElementById('whyPanel').style.display = 'block';
}

// Drag helpers
function drag(simulation){
  return d3.drag()
    .on("start", (event,d)=>{
      if (!event.active) simulation.alphaTarget(0.3).restart();
      d.fx = d.x; d.fy = d.y;
    })
    .on("drag", (event,d)=>{
      d.fx = event.x; d.fy = event.y;
    })
    .on("end", (event,d)=>{
      if (!event.active) simulation.alphaTarget(0);
      d.fx = null; d.fy = null;
    });
}

// Seed data
(function seed(){
  const examples = [
    {name:"Alpha.txt", text:"Alpha guideline for compliance and risk management. This document outlines policies for data handling and third party oversight. Encryption standards and key rotation are mandatory. Vendors must provide incident reporting within 24 hours."},
    {name:"Beta.txt", text:"Beta policy describes operational risk controls and internal audit procedures. Focus on incident reporting and remediation actions. Vendors and outsourcing oversight require encryption and access reviews with key rotation."},
    {name:"Gamma.txt", text:"Gamma standard: information security, data privacy controls, encryption standards, key rotation, user access reviews. Monitoring and alerting thresholds are defined for privileged accounts."},
    {name:"Delta.txt", text:"Delta procedure: vendor due diligence, outsourcing oversight, service level monitoring, business continuity planning. Incident drill exercises ensure response readiness within 24 hours."},
    {name:"Epsilon.txt", text:"Epsilon memo summarizing lessons learned from incidents, near misses, fraud attempts, and conduct breaches. Recommendations include stronger encryption, faster vendor incident reporting, and clearer escalation thresholds."}
  ];
  for(const f of examples){ addDocument(f.name, f.text); }
  recomputeLinks();
  drawGraph();
  renderDocList();
})();

// Resize handling
window.addEventListener('resize', () => {
  const w = container.node().clientWidth;
  const h = container.node().clientHeight;
  svg.attr("viewBox", [0, 0, w, h]);
  sim.force("center", d3.forceCenter(w/2, h/2));
  sim.alpha(0.3).restart();
});
</script>
</body>
</html>
